@page "/diag"
@using System.Net.Http.Json
@using System.Text.Json
@using PoBabyTouchGc.Shared.Models
@inject HttpClient Http
@inject NavigationManager NavigationManager

<PageTitle>PoBabyTouch - Diagnostics</PageTitle>

<h1>PoBabyTouch Diagnostics</h1>

<div class="diagnostics-container">
    <h2>System Status</h2>
    
    @if (isLoading)
    {
        <div class="alert alert-info">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            Running diagnostics...
        </div>
    }
    
    @if (healthData != null)
    {
        <div class="alert @(healthData.Status == "Healthy" ? "alert-success" : "alert-danger")">
            <h4>Overall Status: @healthData.Status</h4>
            <small>Last checked: @healthData.Timestamp.ToLocalTime().ToString("g")</small>
        </div>

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Service</th>
                    <th>Status</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                @if (healthData.Dependencies?.ContainsKey("api") == true)
                {
                    var apiData = healthData.Dependencies["api"];
                    <tr>
                        <td><strong>API Server</strong></td>
                        <td>
                            <span class="badge @GetStatusBadgeClass(apiData.GetProperty("status").GetString())">
                                @apiData.GetProperty("status").GetString()
                            </span>
                        </td>
                        <td>
                            Environment: @apiData.GetProperty("environment").GetString()<br/>
                            Machine: @apiData.GetProperty("machineName").GetString()
                        </td>
                    </tr>
                }

                @if (healthData.Dependencies?.ContainsKey("azureTableStorage") == true)
                {
                    var storageData = healthData.Dependencies["azureTableStorage"];
                    var status = storageData.GetProperty("status").GetString();
                    <tr>
                        <td><strong>Azure Table Storage</strong></td>
                        <td>
                            <span class="badge @GetStatusBadgeClass(status)">
                                @status
                            </span>
                        </td>
                        <td>
                            @if (storageData.TryGetProperty("tableName", out var tableName))
                            {
                                <text>Table: @tableName.GetString()<br/></text>
                            }
                            @if (storageData.TryGetProperty("message", out var message))
                            {
                                <text>@message.GetString()</text>
                            }
                            @if (storageData.TryGetProperty("error", out var error))
                            {
                                <text><span class="text-danger">@error.GetString()</span></text>
                            }
                        </td>
                    </tr>
                }

                @if (healthData.Dependencies?.ContainsKey("applicationInsights") == true)
                {
                    var aiData = healthData.Dependencies["applicationInsights"];
                    var status = aiData.GetProperty("status").GetString();
                    <tr>
                        <td><strong>Application Insights</strong></td>
                        <td>
                            <span class="badge @GetStatusBadgeClass(status)">
                                @status
                            </span>
                        </td>
                        <td>
                            @if (aiData.TryGetProperty("message", out var message))
                            {
                                <text>@message.GetString()</text>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else if (healthError != null)
    {
        <div class="alert alert-danger">
            <h4>Unable to retrieve health status</h4>
            <p>@healthError</p>
        </div>
    }

    <h2>Leaderboard API Test</h2>
    <p>Testing high scores endpoint:</p>
    
    @if (leaderboardEntries != null)
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Initials</th>
                    <th>Score</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                @if (leaderboardEntries.Count > 0)
                {
                    @foreach (var entry in leaderboardEntries)
                    {
                        <tr>
                            <td>@entry.PlayerInitials</td>
                            <td>@entry.Score</td>
                            <td>@entry.Timestamp?.DateTime.ToLocalTime().ToString("g")</td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="3" class="text-center">No leaderboard entries found</td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else if (leaderboardError != null)
    {
        <div class="alert alert-warning">
            <strong>Leaderboard Error:</strong> @leaderboardError
        </div>
    }

    <div class="text-center mt-4">
        <button class="btn btn-primary" @onclick="RunDiagnostics" disabled="@isLoading">
            @if (isLoading)
            {
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            }
            Run Diagnostics Again
        </button>
        <a href="/" class="btn btn-secondary ms-2">Return to Home</a>
    </div>
</div>

<style>
    .diagnostics-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
    }
    .badge {
        padding: 8px 12px;
        font-size: 14px;
    }
</style>

@code {
    private bool isLoading = false;
    private HealthStatus? healthData;
    private string? healthError;
    private List<HighScore>? leaderboardEntries;
    private string? leaderboardError;

    protected override async Task OnInitializedAsync()
    {
        await RunDiagnostics();
    }

    private async Task RunDiagnostics()
    {
        isLoading = true;
        healthError = null;
        leaderboardError = null;
        
        StateHasChanged();

        await CheckHealth();
        await CheckLeaderboardData();

        isLoading = false;
    }

    private async Task CheckHealth()
    {
        try
        {
            var response = await Http.GetAsync("api/health");
            var content = await response.Content.ReadAsStringAsync();
            
            healthData = JsonSerializer.Deserialize<HealthStatus>(content, new JsonSerializerOptions 
            { 
                PropertyNameCaseInsensitive = true 
            });
        }
        catch (Exception ex)
        {
            healthError = $"Error connecting to health endpoint: {ex.Message}";
            healthData = null;
        }
    }

    private async Task CheckLeaderboardData()
    {
        try
        {
            leaderboardEntries = await Http.GetFromJsonAsync<List<HighScore>>("api/highscores");
        }
        catch (Exception ex)
        {
            leaderboardError = ex.Message;
            leaderboardEntries = null;
        }
    }

    private string GetStatusBadgeClass(string? status)
    {
        return status?.ToLower() switch
        {
            "healthy" => "bg-success",
            "configured" => "bg-success",
            "unhealthy" => "bg-danger",
            "error" => "bg-danger",
            "notconfigured" => "bg-warning",
            _ => "bg-secondary"
        };
    }

    private class HealthStatus
    {
        public string Status { get; set; } = "";
        public DateTime Timestamp { get; set; }
        public string Application { get; set; } = "";
        public string Version { get; set; } = "";
        public Dictionary<string, JsonElement>? Dependencies { get; set; }
    }
}
