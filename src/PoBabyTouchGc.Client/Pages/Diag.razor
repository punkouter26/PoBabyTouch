@page "/diag"
@using Microsoft.AspNetCore.Components.Web
@inject HttpClient Http

<PageTitle>PoBabyTouch - Diagnostics</PageTitle>

<div class="diagnostics-container">
    <h1>System Status</h1>
    
    @if (isLoading)
    {
        <div class="alert alert-info">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            Checking API health...
        </div>
    }
    
    @if (apiHealthy)
    {
        <div class="alert alert-success">
            <h4>✅ API is healthy</h4>
            <small>Last checked: @lastCheckTime</small>
        </div>
    }
    else if (!isLoading)
    {
        <div class="alert alert-danger">
            <h4>❌ API unavailable</h4>
            <p>@errorMessage</p>
        </div>
    }

    <div class="text-center mt-4">
        <button class="btn btn-primary" @onclick="CheckHealth" disabled="@isLoading">
            @if (isLoading)
            {
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            }
            Refresh Status
        </button>
        <a href="/" class="btn btn-secondary ms-2">Return to Home</a>
    </div>
</div>

<style>
    .diagnostics-container {
        max-width: 600px;
        margin: 50px auto;
        padding: 20px;
    }
</style>

@code {
    private bool isLoading = false;
    private bool apiHealthy = false;
    private string lastCheckTime = "";
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await CheckHealth();
    }

    private async Task CheckHealth()
    {
        isLoading = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            var response = await Http.GetAsync("api/health");
            apiHealthy = response.IsSuccessStatusCode;
            lastCheckTime = DateTime.Now.ToString("g");
            
            if (!apiHealthy)
            {
                errorMessage = $"API returned status code: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            apiHealthy = false;
            errorMessage = $"Error connecting to API: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
