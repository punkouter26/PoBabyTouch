@page "/stats"
@inject HttpClient Http
@inject ILogger<Stats> Logger

<PageTitle>Statistics - PoBabyTouch</PageTitle>

<div class="stats-container">
    <FluentStack Orientation="FluentOrientation.Vertical" VerticalGap="20">
        <div class="stats-header">
            <h1>
                üìä Game Statistics
            </h1>
        </div>

        @if (isLoading)
        {
            <FluentProgressRing />
            <p>Loading statistics...</p>
        }
        else if (errorMessage != null)
        {
            <FluentMessageBar Intent="MessageIntent.Error">
                @errorMessage
            </FluentMessageBar>
        }
        else if (playerStats != null)
        {
            <!-- Player Summary Card -->
            <FluentCard Class="player-summary-card">
                <FluentStack Orientation="FluentOrientation.Vertical" VerticalGap="15">
                    <h2>Your Statistics</h2>
                    
                    <FluentGrid Spacing="3">
                        <FluentGridItem xs="12" sm="6" md="3">
                            <div class="stat-box">
                                üèÜ
                                <div class="stat-value">@playerStats.HighestScore</div>
                                <div class="stat-label">Highest Score</div>
                            </div>
                        </FluentGridItem>
                        
                        <FluentGridItem xs="12" sm="6" md="3">
                            <div class="stat-box">
                                üèÜ
                                <div class="stat-value">@playerStats.AverageScore.ToString("F1")</div>
                                <div class="stat-label">Average Score</div>
                            </div>
                        </FluentGridItem>
                        
                        <FluentGridItem xs="12" sm="6" md="3">
                            <div class="stat-box">
                                üèÜ
                                <div class="stat-value">@playerStats.TotalGames</div>
                                <div class="stat-label">Games Played</div>
                            </div>
                        </FluentGridItem>
                        
                        <FluentGridItem xs="12" sm="6" md="3">
                            <div class="stat-box">
                                üèÜ
                                <div class="stat-value">@FormatPlaytime(playerStats.TotalPlaytimeSeconds)</div>
                                <div class="stat-label">Total Playtime</div>
                            </div>
                        </FluentGridItem>
                    </FluentGrid>
                    
                    <!-- Percentile Rank -->
                    <div class="percentile-section">
                        <h3>Your Rank</h3>
                        <FluentProgressRing 
                            Value="@((int)playerStats.PercentileRank)" 
                            Max="100"
                            Class="percentile-ring">
                        </FluentProgressRing>
                        <p class="percentile-text">
                            Top @((100 - playerStats.PercentileRank).ToString("F1"))% of players!
                        </p>
                    </div>
                </FluentStack>
            </FluentCard>

            <!-- Score Distribution Chart -->
            @if (scoreDistributionData.Any())
            {
                <FluentCard Class="chart-card">
                    <h3>Score Distribution</h3>
                    <RadzenChart>
                        <RadzenColumnSeries Data="@scoreDistributionData" 
                                          CategoryProperty="Range" 
                                          ValueProperty="Count"
                                          Title="Games"
                                          Fill="#FF6600" />
                        <RadzenColumnOptions Radius="5" />
                        <RadzenValueAxis>
                            <RadzenGridLines Visible="true" />
                            <RadzenAxisTitle Text="Number of Games" />
                        </RadzenValueAxis>
                        <RadzenCategoryAxis>
                            <RadzenAxisTitle Text="Score Range" />
                        </RadzenCategoryAxis>
                    </RadzenChart>
                </FluentCard>
            }

            <!-- Additional Stats -->
            <FluentCard Class="additional-stats-card">
                <FluentStack Orientation="FluentOrientation.Vertical" VerticalGap="10">
                    <h3>Additional Statistics</h3>
                    
                    <div class="stat-row">
                        <span class="stat-row-label">Total Circles Tapped:</span>
                        <span class="stat-row-value">@playerStats.TotalCirclesTapped</span>
                    </div>
                    
                    <div class="stat-row">
                        <span class="stat-row-label">First Played:</span>
                        <span class="stat-row-value">@playerStats.FirstPlayed.ToLocalTime().ToString("MMM dd, yyyy")</span>
                    </div>
                    
                    <div class="stat-row">
                        <span class="stat-row-label">Last Played:</span>
                        <span class="stat-row-value">@playerStats.LastPlayed.ToLocalTime().ToString("MMM dd, yyyy HH:mm")</span>
                    </div>
                    
                    <div class="stat-row">
                        <span class="stat-row-label">Average Circles per Game:</span>
                        <span class="stat-row-value">@((playerStats.TotalCirclesTapped / (double)playerStats.TotalGames).ToString("F1"))</span>
                    </div>
                </FluentStack>
            </FluentCard>
        }
        else
        {
            <FluentMessageBar Intent="MessageIntent.Info">
                No statistics available yet. Play a game to start tracking your stats!
            </FluentMessageBar>
        }

        <!-- Navigation Buttons -->
        <FluentStack Orientation="FluentOrientation.Horizontal" HorizontalAlignment="HorizontalAlignment.Center" HorizontalGap="15">
            <FluentButton Appearance="Appearance.Accent" 
                          OnClick="@(() => Navigation.NavigateTo("/"))"
                          aria-label="Go back to home">
                üè† Home
            </FluentButton>
            
            <FluentButton Appearance="Appearance.Accent"
                          OnClick="@(() => Navigation.NavigateTo("/leader"))"
                          aria-label="View leaderboard">
                üèÜ Leaderboard
            </FluentButton>
        </FluentStack>
    </FluentStack>
</div>

@code {
    [Inject] private NavigationManager Navigation { get; set; } = default!;
    [Parameter] [SupplyParameterFromQuery] public string? Initials { get; set; }
    
    private GameStats? playerStats;
    private List<ScoreDistribution> scoreDistributionData = new();
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadStatistics();
    }

    private async Task LoadStatistics()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            // Get initials from query parameter or localStorage
            var initials = Initials ?? await GetStoredInitialsAsync();
            
            if (string.IsNullOrEmpty(initials))
            {
                errorMessage = "Please play a game first to track statistics";
                isLoading = false;
                return;
            }

            var response = await Http.GetFromJsonAsync<ApiResponse<GameStats>>($"api/stats/{initials}");
            
            if (response?.Success == true && response.Data != null)
            {
                playerStats = response.Data;
                ParseScoreDistribution();
            }
            else
            {
                errorMessage = response?.Message ?? "Failed to load statistics";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading statistics");
            errorMessage = "An error occurred while loading statistics";
        }
        finally
        {
            isLoading = false;
        }
    }

    private Task<string?> GetStoredInitialsAsync()
    {
        // This would typically use localStorage via JS Interop
        // For now, return null - will be enhanced later
        return Task.FromResult<string?>(null);
    }

    private void ParseScoreDistribution()
    {
        if (playerStats == null || string.IsNullOrEmpty(playerStats.ScoreDistribution))
            return;

        scoreDistributionData.Clear();
        
        foreach (var entry in playerStats.ScoreDistribution.Split(',', StringSplitOptions.RemoveEmptyEntries))
        {
            var parts = entry.Split(':');
            if (parts.Length == 2)
            {
                scoreDistributionData.Add(new ScoreDistribution
                {
                    Range = parts[0],
                    Count = int.Parse(parts[1])
                });
            }
        }
    }

    private string FormatPlaytime(int seconds)
    {
        var timespan = TimeSpan.FromSeconds(seconds);
        
        if (timespan.TotalHours >= 1)
            return $"{(int)timespan.TotalHours}h {timespan.Minutes}m";
        else if (timespan.TotalMinutes >= 1)
            return $"{(int)timespan.TotalMinutes}m {timespan.Seconds}s";
        else
            return $"{seconds}s";
    }

    private class ScoreDistribution
    {
        public string Range { get; set; } = string.Empty;
        public int Count { get; set; }
    }
}
